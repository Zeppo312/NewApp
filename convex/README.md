# Convex Backend Setup

This directory contains the Convex backend configuration for LottiBaby's dual-backend architecture.

## Architecture Overview

LottiBaby implements a **dual-backend architecture** where:
- **Auth**: Remains in Supabase
- **Dual-Write**: All write operations go to both Supabase and Convex in parallel
- **Selective Read**: Reads from the user's preferred backend (configurable via admin toggle)
- **Admin Toggle**: Backend selection switch visible only to admins

## Setup Instructions

### Prerequisites

**Important**: Convex CLI requires Node.js 20+. Ensure you are on Node 20+ (`node --version`).

To proceed with Convex setup, you need to:
1. Upgrade Node.js to version 20 or higher
2. Or use a Node version manager (nvm) to switch versions (`nvm use 20`)

### Initial Setup

Once you have Node 20+:

```bash
# 1. Initialize Convex project
npx convex dev

# This will:
# - Create a Convex project
# - Generate type definitions in convex/_generated/
# - Give you a deployment URL

# 2. Add the deployment URL to .env.local
# EXPO_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud

# 3. Deploy to production
npx convex deploy
```

### Schema

The schema in `schema.ts` mirrors the Supabase database structure:

- **users**: Syncs Supabase user IDs with Convex
- **doctor_questions**: Stores doctor questions (matches Supabase table)

### Functions

#### Auth Functions (`auth.ts`)
- `getUser`: Query to fetch user by Supabase ID
- `verifyAndSyncUser`: Mutation to create/update user in Convex

#### Doctor Questions Functions (`doctorQuestions.ts`)
- `listQuestions`: Query to fetch all questions for a user
- `createQuestion`: Mutation to create a new question
- `updateQuestion`: Mutation to update a question
- `deleteQuestion`: Mutation to delete a question

## Development Workflow

### Without Convex Running
The app will function normally using Supabase only. The Convex client will not initialize if `EXPO_PUBLIC_CONVEX_URL` is not set.

### With Convex Running
1. Set `EXPO_PUBLIC_CONVEX_URL` in `.env.local`
2. Run `npx convex dev` in a terminal
3. The app will dual-write to both backends
4. Admins can toggle between backends using the header toggle

## Testing Dual-Write

1. Login as an admin user (ID must be in `BackendContext.tsx` ADMIN_USER_IDS)
2. You'll see a "SB" or "CX" toggle in the header
3. Create a doctor question
4. Check both Supabase and Convex dashboards - the question should exist in both
5. Toggle the backend and verify you can read from both

## Monitoring

### Console Logs
The dual-write system logs:
- **Success**: When both writes succeed
- **Warning**: When secondary write fails (user still sees success)
- **Error**: When primary write fails (user sees error)

Example:
```
[DualWrite] Secondary backend (convex) write failed: <error>
```

### Data Consistency
- IDs are generated by Supabase and passed to Convex
- Timestamps are synchronized
- Primary backend determines success/failure

## Future Expansion

To add more features to the dual-backend system:

1. Create schema tables in `schema.ts`
2. Create Convex functions
3. Create a service class in `lib/services/`
4. Create a hook in `hooks/`
5. Refactor the component to use the service

See `DoctorQuestionsService.ts` as a reference implementation.

## Troubleshooting

### "Convex client not available" errors
- Check that `EXPO_PUBLIC_CONVEX_URL` is set in `.env.local`
- Verify Convex dev server is running (`npx convex dev`)
- Check console for initialization errors

### Type errors in generated files
- Run `npx convex dev` to regenerate types
- Make sure `convex/_generated/` is not gitignored

### Dual-write failures
- Check network connectivity
- Verify both backends are accessible
- Check console logs for specific errors
